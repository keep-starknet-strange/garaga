from garaga.definitions import CurveID, get_base_field
from garaga.modulo_circuit import ModuloCircuit, ModuloCircuitElement
from garaga.modulo_circuit_structs import u384

# Global circuit definition
curve_id = CurveID.GRUMPKIN  # BN254
field = get_base_field(curve_id)
COMPILATION_MODE = 1  # 1 for Cairo, 0 for CairoZero.

circuit = ModuloCircuit(
    name=f"poseidon_{curve_id.name.lower()}",
    curve_id=curve_id.value,
    generic_circuit=False,
    compilation_mode=COMPILATION_MODE,
)

# Define inputs to the circuit
x = circuit.write_struct(u384("x", [field(1)]))  # Input x = 1
y = circuit.write_struct(u384("y", [field(2)]))  # Input y = 2


# Utility functions for Poseidon hash
def sigma(value):
    """Applies the Poseidon sigma function."""
    x2 = circuit.mul(value, value)  # (value * value)
    x4 = circuit.mul(x2, x2)  # (x2 * x2)
    return circuit.mul(x4, value)  # (x4 * value)


def ark(t, C, r, state):
    """Applies the Ark step of the Poseidon hash."""
    return [circuit.add(state[i], C[i + r]) for i in range(t)]


def iterated_add(terms):
    """Performs iterative addition since circuit.add can only take two parameters."""
    result = terms[0]
    for term in terms[1:]:
        result = circuit.add(result, term)
    return result


def iterated_mul(terms):
    """Performs iterative multiplication since circuit.mul can only take two parameters."""
    result = terms[0]
    for term in terms[1:]:
        result = circuit.mul(result, term)
    return result


def mix(t, M, state):
    """Applies the Mix step of the Poseidon hash."""
    return [
        iterated_add([circuit.mul(M[j][i], state[j]) for j in range(t)])
        for i in range(t)
    ]


def mix_last(t, M, s, state):
    """Applies the MixLast step of the Poseidon hash."""
    return iterated_add([circuit.mul(M[j][s], state[j]) for j in range(t)])


def mix_s(t, S, r, state):
    """Applies the MixS step of the Poseidon hash."""
    result = [
        iterated_add([circuit.mul(S[(t * 2 - 1) * r + i], state[i]) for i in range(t)])
    ]
    result.extend(
        circuit.add(state[i], circuit.mul(state[0], S[(t * 2 - 1) * r + t + i - 1]))
        for i in range(1, t)
    )
    return result


def poseidon_hash(
    x: ModuloCircuitElement, y: ModuloCircuitElement
) -> ModuloCircuitElement:
    """Computes the Poseidon hash for two inputs x and y."""
    if isinstance(x, int):
        x = circuit.write_element(x)
    if isinstance(y, int):
        y = circuit.write_element(y)
    if not isinstance(x, ModuloCircuitElement) or not isinstance(
        y, ModuloCircuitElement
    ):
        raise ValueError("x and y must be ModuloCircuitElement instances")

    t = 3  # 2 inputs + 1 state
    n_rounds_f = 8  # Full rounds
    n_rounds_p = 57  # Partial rounds

    state = [circuit.set_or_get_constant(0), x, y]

    # Example constants (these should match the specific Poseidon implementation)
    POSEIDON_C = [
        0xEE9A592BA9A9518D05986D656F40C2114C4993C11BB29938D21D47304CD8E6E,
        0xF1445235F2148C5986587169FC1BCD887B08D4D00868DF5696FFF40956E864,
        0x8DFF3487E8AC99E1F29A058D0FA80B930C728730B7AB36CE879F3890ECF73F5,
        0x84D520E4E5BB469E1F9075CB7C490EFA59565EEDAE2D00CA8EF88CEEA2B0197,
        0x2D15D982D99577FA33DA56722416FD734B3E667A2F9F15D8EB3E767AE0FD811E,
        0xED2538844ABA161CF1578A43CF0364E91601F6536A5996D0EFBE65632C41B6D,
        0x2600C27D879FBCA186E739E6363C71CF804C877D829B735DCC3E3AF02955E60A,
        0x28F8BD44A583CBAA475BD15396430E7CCB99A5517440DFD970058558282BF2C5,
        0x9CD7D4C380DC5488781AAD012E7EAEF1ED314D7F697A5572D030C55DF153221,
        0x11BB6EE1291AABB206120ECAACE460D24B6713FEBE82234951E2BEE7D0F855F5,
        0x2D74E8FA0637D9853310F3C0E3FAE1D06F171580F5B8FD05349CADEECFCEB230,
        0x2735E4EC9D39BDFFAC9BEF31BACBA338B1A09559A511A18BE4B4D316ED889033,
        0xF03C1E9E0895DB1A5DA6312FAA78E971106C33F826E08DCF617E24213132DFD,
        0x17094CD297BF827CAF92920205B719C18741090B8F777811848A7E9EAD6778C4,
        0xDB8F419C21F92461FC2B3219465798348DF90D4178042C81BA7D4B4D559E2B8,
        0x243443613F64FFA417427ED5933FCFBC66809DB60B9CA1724A22709CECEEECE2,
        0x22AF49FBFD5D7E9FCD256C25C07D3DD8ECBBAE6DEECD03AA04BB191FADA75411,
        0x14FBD37FA8AD6E4E0C78A20D93C7230C4677F797B4327323F7F7C097C19420E0,
        0x15A9298BBB882534D4B2C9FBC6E4EF4189420C4EB3F3E1EA22FAA7E18B5AE625,
        0x2F7DE75F23DDAAA5221323EBCEB2F2AC83EEF92E854E75434C2F1D90562232BC,
        0x36A4432A868283B78A315E84C4AE5AECA216F2FF9E9B2E623584F7479CD5C27,
        0x2180D7786A8CF810E277218AB14A11E5E39F3C962F11E860AE1C5682C797DE5C,
        0xA268EF870736EEBD0CB55BE640D73EE3778990484CC03CE53572377EEFFF8E4,
        0x1EEFEFE11C0BE4664F2999031F15994829E982E8C90E09069DF9BAE16809A5B2,
        0x27E87F033BD1E0A89CA596E8CB77FE3A4B8FB93D9A1129946571A3C3CF244C52,
        0x1498A3E6599FE243321F57D6C5435889979C4F9D2A3E184D21451809178EE39,
        0x27C0A41F4CB9FE67E9DD4D7CE33707F74D5D6BCC235BEF108DEA1BBEBDE507AA,
        0x1F75230908B141B46637238B120FC770F4F4AE825D5004C16A7C91FE1DAE280F,
        0x25F99A9198E923167BBA831B15FFFD2D7B97B3A089808D4EB1F0A085BEE21656,
        0x101BC318E9EA5920D0F6ACDC2BB526593D3D56EC8ED14C67622974228BA900C6,
        0x1A175607067D517397C1334ECB019754EBC0C852A3CF091EC1CCC43207A83C76,
        0xF02F0E6D25F9EA3DEB245F3E8C381EE6B2EB380BA4AF5C1C4D89770155DF37B,
        0x151D757ACC8237AF08D8A6677203EC9692565DE456AE789FF358B3163B393BC9,
        0x256CD9577CEA143049E0A1FE0068DD20084980EE5B757890A79D13A3A624FAD4,
        0x513ABAFF6195EA48833B13DA50E0884476682C3FBDD195497B8AE86E1937C61,
        0x1D9570DC70A205F36F610251EE6E2E8039246E84E4AC448386D19DBAC4E4A655,
        0x18F1A5194755B8C5D5D7F1BF8AAA6F56EFFB012DD784CF5E044EEC50B29FC9D4,
        0x266B53B615EF73AC866512C091E4A4F2FA4BB0AF966EF420D88163238EEBBCA8,
        0x2D63234C9207438AA42B8DE27644C02268304DFEB8C89A1A3F4FD6E8344AE0F7,
        0x2AB30FBE51EE49BC7B3ADDE219A6F0B5FBB976205EF8DF7E0021DAEE6F55C693,
        0x1AEE6D4B3EBE9366DCB9CCE48969D4DF1DC42ABCD528B270068D9207FA6A45C9,
        0x1891AEAB71E34B895A79452E5864AE1D11F57646C60BB34AA211D123F6095219,
        0x24492B5F95C0B0876437E94B4101C69118E16B2657771BD3A7CAAB01C818AA4B,
        0x1752161B3350F7E1B3B2C8663A0D642964628213D66C10AB2FDDF71BCFDE68F,
        0xAB676935722E2F67CFB84938E614C6C2F445B8D148DE54368CFB8F90A00F3A7,
        0xB0F72472B9A2F5F45BC730117ED9AE5683FC2E6E227E3D4FE0DA1F7AA348189,
        0x16AA6F9273ACD5631C201D1A52FC4F8ACAF2B2152C3AE6DF13A78A513EDCD369,
        0x2F60B987E63614EB13C324C1D8716EB0BF62D9B155D23281A45C08D52435CD60,
        0x18D24AE01DDE92FD7606BB7884554E9DF1CB89B042F508FD9DB76B7CC1B21212,
        0x4FC3BF76FE31E2F8D776373130DF79D18C3185FDF1593960715D4724CFFA586,
        0xD18F6B53FC69546CFDD670B41732BDF6DEE9E06B21260C6B5D26270468DBF82,
        0xBA4231A918F13ACEC11FBAFA17C5223F1F70B4CDB045036FA5D7045BD10E24,
        0x7B458B2E00CD7C6100985301663E7EC33C826DA0635FF1EBEDD0DD86120B4C8,
        0x1C35C2D96DB90F4F6058E76F15A0C8286BBA24E2ED40B16CEC39E9FD7BAA5799,
        0x1D12BEA3D8C32A5D766568F03DD1ECDB0A4F589ABBEF96945E0DDE688E292050,
        0xD953E20022003270525F9A73526E9889C995BB62FDEA94313DB405A61300286,
        0x29F053EC388795D786A40BEC4C875047F06FF0B610B4040A760E33506D2671E1,
        0x4188E33735F46B14A4952A98463BC12E264D5F446E0C3F64B9679CAAAE44FC2,
        0x149EC28846D4F438A84F1D0529431BB9E996A408B7E97EB3BF1735CDBE96F68F,
        0xDE20FAE0AF5188BCA24B5F63630BAD47AEAFD98E651922D148CCE1C5FDDDEE8,
        0x12D650E8F790B1253EA94350E722AD2F7D836C234B8660EDF449FBA6984C6709,
        0x22AB53AA39F34AD30EA96717BA7446AAFDADBC1A8ABE28D78340DFC4BABB8F6C,
        0x26503E8D4849BDF5450DABEA7907BC3DE0DE109871DD776904A129DB9149166C,
        0x1D5E7A0E2965DFFA00F5454F5003C5C8EC34B23D897E7FC4C8064035B0D33850,
        0xEE3D8DAA098BEE012D96B7EC48448C6BC9A6AEFA544615B9CB3C7BBD07104CB,
        0x1BF282082A04979955D30754CD4D9056FA9EF7A7175703D91DC232B5F98EAD00,
        0x7AE1344ABFC6C2CE3E951BC316BEE49971645F16B693733A0272173EE9AD461,
        0x217E3A247827C376EC21B131D511D7DBDC98A36B7A47D97A5C8E89762EE80488,
        0x215FFE584B0EB067A003D438E2FBE28BABE1E50EFC2894117509B616ADDC30EE,
        0x1E770FC8ECBFDC8692DCEDC597C4CA0FBEC19B84E33DA57412A92D1D3CE3EC20,
        0x2F6243CDA919BF4C9F1E3A8A6D66A05742914FC19338B3C0E50E828F69FF6D1F,
        0x246EFDDC3117ECD39595D0046F44AB303A195D0E9CC89345D3C03FF87A11B693,
        0x53E8D9B3EA5B8ED4FE006F139CBC4E0168B1C89A918DFBE602BC62CEC6ADF1,
        0x1B894A2F45CB96647D910F6A710D38B7EB4F261BEEFFF135AEC04C1ABE59427B,
        0xAEB1554E266693D8212652479107D5FDC077ABF88651F5A42553D54EC242CC0,
        0x16A735F6F7209D24E6888680D1781C7F04BA7D71BD4B7D0E11FAF9DA8D9CA28E,
        0x487B8B7FAB5FC8FD7C13B4DF0543CD260E4BCBB615B19374FF549DCF073D41B,
        0x1E75B9D2C2006307124BEA26B0772493CFB5D512068C3AD677FDF51C92388793,
        0x5120E3D0E28003C253B46D5FF77D272AE46FA1E239D1C6C961DCB02DA3B388F,
        0xDA5FEB534576492B822E8763240119AC0900A053B171823F890F5FD55D78372,
        0x2E211B39A023031A22ACC1A1F5F3BB6D8C2666A6379D9D2C40CC8F78B7BD9ABE,
    ]
    POSEIDON_M = [
        [
            0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
            0x2969F27EED31A480B9C36C764379DBCA2CC8FDD1415C3DDED62940BCDE0BD771,
            0x143021EC686A3F330D5F9E654638065CE6CD79E28C5B3753326244EE65A1B1A7,
        ],
        [
            0x16ED41E13BB9C0C66AE119424FDDBCBC9314DC9FDBDEEA55D6C64543DC4903E0,
            0x2E2419F9EC02EC394C9871C832963DC1B89D743C8C7B964029B2311687B1FE23,
            0x176CC029695AD02582A70EFF08A6FD99D057E12E58E7D7B6B16CDFABC8EE2911,
        ],
        [
            0x2B90BBA00FCA0589F617E7DCBFE82E0DF706AB640CEB247B791A93B74E36736D,
            0x101071F0032379B697315876690F053D148D4E109F5FB065C8AACC55A0F89BFA,
            0x19A3FC0A56702BF417BA7FEE3802593FA644470307043F7773279CD71D25D5E0,
        ],
    ]
    POSEIDON_P = [
        [
            0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
            0x1E6F20A11D1E31E43F83DCEDDDB9A0236203F5F24AE72C925A8A79A66831F51D,
            0x1BD8C528472E57BDC722A141F8785694484F426725403AE24084E3027E782467,
        ],
        [
            0x16ED41E13BB9C0C66AE119424FDDBCBC9314DC9FDBDEEA55D6C64543DC4903E0,
            0x2D51BA82C8073C6D6BACF1AD5E56655B7143625B0A9E9C3190527A1A5F05079A,
            0x1B07D6D51E6F7E97E0AB10FC2E51EA83CE0611F940FF0731B5F927FE8D6A77C9,
        ],
        [
            0x2B90BBA00FCA0589F617E7DCBFE82E0DF706AB640CEB247B791A93B74E36736D,
            0x11E12A40D262AE88E8376F62D19EDF43093CDEF1CCF34D985A3E53F0BC5765A0,
            0x221C170E4D02A2479C6F3E47B5FF55781574F980D89038308A3EF37CCE8463BD,
        ],
    ]
    POSEIDON_S = [
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x3F0815AB463F1B76EE25A9B8768B3231A89752F427F4F063AB718E707576B31,
        0x15648BF46F60D82954C7E33029B3617357012A3D3B1D34C8E008859F1DBFB317,
        0x127E00C2253DE07818CA7F2EAFDD7564D05EA850CF61F1DAA0CFEFBF7FBFBA85,
        0x66365AFD18A41EF9382FC0B1D265CB4D3CE470A8CBBB878F7D48051630747BD,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x219D14F823513140DC69A96F7FE7E086F4FA24C84E57DCF2B099715C4404AAE7,
        0x3A30BFBBF2CB86D4A6A63A8050D91F9F14F4D33696D37EBAEFA9AC2302132D5,
        0x2121BBCDEAA33A35B0270FB7D5C9F94EDAD5A84D74B06E3385104B0B41935BCC,
        0x196B544FBEB0A792CFBB82C289E579B7CD5580C2E338A389D053EF8B3D10E70E,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x2809C3A1547C0CEE89C1DB270EF479C26973EC73EDB4BD4E7D907EA0202F560F,
        0x11C34446B083EF92CA157585A02B8B342A4C67175B31F4B5D40D4E96DFC5C8F1,
        0x253EA0B33A8BF3B2367C030E3289CBE0F6242AD7709D90B86D9D8026E2E39925,
        0x30467DC1930F6AFE90C89D4007AD29FC4F5A19C006D1030438C16DF85637BD5F,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x2F9D4B55495F7E377E20E6F5A3A88AF7AA6A536458B38BBE13C8EBFBBBA54F44,
        0x1D9E9D5C736E3151F11D36D499E7E093D8EE2353BE18AAD54CFD03FF0FEAC4B8,
        0x124B617B43E598F9EBF622F7823A3DE7D1BFEDB87E097C315F343DE301E54841,
        0x198E7CFC66AE45774055CF073BEDC945A5F9C5B19CAE08D789CC5748FFE199B2,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x2EAC25B3498DFADFFD124AB3AAD57789EB945BA57443099C5BB6C27ED977FE24,
        0x1EE02C175CDFE1871B378305C1BB9C904E8AF1D4454ED3550B3C6AB5F4F90126,
        0x616F8C34C607266B29EA8F9D2DFA47FF6FBB1D9745C48609FA98301D0F679D5,
        0x181D68B0A188504958B9F19CBBDB972A853E51ED385E4883A43A42832803370B,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x2D5397CE863464A25D6B7F5B015D579181D1CE2F24CBABF6059E9327F5BA7004,
        0x15BF817491B94D71E8912940CC0B80277713E7D32DA2B6591724D8DBD4BC2618,
        0x2A7CBD11460B177AB76FEAB28B69485AC8CC687740BC910994A3827D29C08714,
        0xF7CD5FFA4661730AB56E447FAE5CC1763CB462DA80A85614C237B290DE9D502,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0xE0766004B4C4176EB13273508EB6575F768137D86D305BE644CE04531008100,
        0x625FA7145813481F6D148BE6B9C8BB7B54EE3C1AFAC00104E1F763000B9924C,
        0x7C5472508B459916EE0F5461AAD2E0B19CD9C7B184F515B65136318CE2C6A5,
        0x567375470D189B693AC77AB3FB7557231D53073951D43C54685879CB7A89FCB,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x1D0406BCBEC83F8D5165F56C063E42108AD21F51EA4BFC71601174BA5C7B8BCC,
        0xC02B18EEF22332D280A8AA1F86405F3375F06342F8696EE7C73B46C63272CB7,
        0x17C1FC174CD9A6EBEAA7ADD2F801A664823509AD4FD1B15AAD053A55AD6DA4CF,
        0x5F843C23024EB1DAB7EBBC86709A021AAA6CAF433F7ED258A08638E9584B32D,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x22DF2420697CA28B5CC51C53165E002727B45CCD90A55C87589F792F0AD8CB37,
        0x2F1438303A7B49D473400AAEDF0F48009FD3AF804B76BE86417588EFC4D7302A,
        0x2323D5FCF2DA8965C6B2B7B4FBF9A24BBAA7F4DCCD35D5CA6155C5463093B23B,
        0x26C85B9DFBBE48FE83B753A5E7336B9F40F7B961E9C54F94E37700073D4D26E,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x31511000251EC86FEB38B5AB4E335F070B271DF4C20979528E41D65384C318F,
        0x18E588324A9BBAACB42FA69E5D90A0C0E27CD16B941E34A60FF5DF9A26C03AF1,
        0x2642B5D8E16B953B070635775C8D3C9498357D6AD9BEF2E7D99F03C10EA1F95F,
        0x21FC313BA11C60E8E84FF60DB906A0F031189B0B48335C4221F909AEF836C133,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x2D3562E3D4B42BC6890B698CC6AB89F7311298BCBAC6E4E9F2F4D93D06DAE151,
        0xA74EF541D360E842E3E0B6FF7E5C7C77934A5F67616F01C189D886DFD2E0808,
        0x140564B53E0A812AC3983D6E3B433AFA43F434087D9E754967C2C9B1B02CAF8A,
        0x14709E32D98AE4CD18B400181E71AB9759C436C8E83FA6993ADB6F2DB6BBA9D0,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x734B2366C59E394423F179E1266DD392372DB4F2DBA651F4A619A4B52BDC010,
        0x11FB2D705C94B08D5AD3E3C5FB6629ABE963ED92913642C7D02D7E71088FD2D4,
        0x27D03ABF5C1F290E5D715EBA19371050EF6EB7F78FD84BE834E4CC3618059484,
        0x13ED9E9E6B452DF27FB3353CFC2CD63EBE817F212A39C6A8BB9B441AC1395861,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x1319C51CF37AAA10246CDAAA04A12E88795DE4452604263A7C5B79AB99CBD23C,
        0xBCA25588D187B7F9DAD839F2C8CB526A4CF444EEBBD0E715B6CEA019AC3F2,
        0x1D837EA0341C5964181226874B923CD01A069B493F02F7A3C01BE23CF51D593F,
        0x1B41CE9ED3634CBD42C427CE4C5C83774149E2A6DBD25F24012090DB7DE4E7F9,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x671F0E3B674AE7CDDC790ECC4E946F4BCA74B98B78A127C7B56BD6673F1CE1F,
        0x19FC073797A39B272E40CD30615F55FEFEB682C1AC14143071D0449A5426E4E,
        0x17BEE47D262A497FD1F7C5C6D5A7C70FA4209480BF5D97311C5096619E9FD13,
        0x2073CFF92D3141B480763539CFF2978A4C7944721CC937BA00CC8527274471E3,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x3BD7B3E2C1885877F43182A55A91D48F9C58D152E730FE2C7AA46B1FA663BAA,
        0x226EBC9A538B5BBAFF128EDFB9BBF5FA0CEB100719A14C8DFED9FFBBBAD9B6B7,
        0xD395F0B08B9FEDE0373A06E1552C0E634A49572AF1D830DC6E394E8A5D3B21A,
        0x28242439B524540A30D49B68E19E31BA5284BD3BCF1E0F2F41F77D5331F99FFA,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x370D6FA19EAAC142D2DE034801AB85E0B457E129E91F929754B48C6154D4DF6,
        0x9A16F573B3280F390762ABF269579EAA37939BC0C753FEB0A2B2E0BCBDE1659,
        0x2228E360FB5B162B496AC443F98127EE3C0021A690B71B268D99981368231D97,
        0x7E42C2CA633D2C49FABF83991476D209431E34D8032B6A1B97675F3C567F944,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x2CE12D7269663770C3CAB85A6215A32EED35FDA1D8E9D753A50FE96097724A9F,
        0x3D7427704C61E2009EEB9B1B45A0125084BC4DAF70973A7BA0B2231815B15DE,
        0x10F8ABF0764185861C1267FCF4B4B33CA096FB4DDC4626732D86921E553E69C6,
        0x17CCAF6F26F7267A025D7CB456E3AEB251A1A620AAF6568A5C95644C7C5914CC,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x63BB306B96310051385C3CE00CA820AD0E3651A6E55754D59DE6DF28CEA4D51,
        0x1F761EE5553C5E86F2C304A18095AB7403242E0B65E608BC920CF993A4169974,
        0xDC5F00BBFD7C1D9A23C0E666859BA6564BCDE8761B45717CD6BDFC09DE4E8F2,
        0x6DE511520E277B7DF07C3536381C13EB44CF790A230ABC391089760BFC40EF2,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x2A134348C8660EFCF9EF54863E70528A1FD4481B50A1FE21F24A8C06E10CCA03,
        0xAEB5023BBB9A64C4BD80089E99EDF8ED5F6F1FFB63A7DBBA1B33520BCFCE37B,
        0x141A6D0810366AE225ECB5F0BFDC9995406C5960AB26155836FC51FB7CB933D1,
        0x9D2EA05EF54DADBBE776F404DCA6626CC0B2539990BC0B8BFE87497F1E2C5B7,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x1E56D244A8E41BE5D104D5F8EF70891D22D4A5432441BFE8FF1A16E91719CDDE,
        0x1D4F020C57C4F14AEC908B2F99B5C4FD5E09447FA85C2FD68BA4D5C5F50C7B49,
        0x763911A3A92A4F0E09F4E14CD03398D8D82A1E09DB80FB0EE1E833764C18FD3,
        0x12857275BE2FE6B9BA2EC68F9061643F1FC5D9A2C5E47E55684366E54B302946,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x2ED11CCD2E2E2376655FFE9A96C4B81ADC0A60353C5D83D4D0EBF50D1BBF87C0,
        0x3E31DE8958E82645B320D5E3E966EF4726D5B1C2CFBB4ACD288A21543C6D594,
        0x11E880DFEFDBD08858AE890046533D58DA28A608D7E905366EC2CA4A36E71963,
        0x1835B275DEAED2D00704A9C3CC21AB7A44A34662978D53C190DC25E969A507B2,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x68B75315E25ED4ACE5A4A9480E1D82CE5D44F76F1324240419F372FF8D3C3F5,
        0x1B7EF7D04AEC73D62B052D2AD12B92A4268FCCD795C839D698AD3B22823274D1,
        0x28C0C848022A90606F6193FF5501B57216B670727F4B8EFCC240D30BBAA9F03F,
        0x13BDA49296CBCC51686A7BFB1C39F3F254370985A16660EFD6E5D82D4F068E1B,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x2E7987EA8204389D11EB10B34265E378A945729F86C3E0E2FD38490D3A594141,
        0x826D4A2324AD3AA4B2B45C10A190FEDEF702AEFFDA3226CE5415FFFD03935C8,
        0x2DBEEE85EAEAA9FA3675EF541C9DF7BB964A85435C3B59685F93B434036DED,
        0x227EE7A945EDAEE6919418ECB3279B11E6FA44F5F5C5ABFB966A4BE599CB86C7,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x1D0A6D1A9519877805AC90D696FAF2A5FFADC23986DE8C698D541471C7244220,
        0x2208AABA508AE816DA4F333B7854FBBCD10EEA1DB284EC3E9F4DE02B25F6E9D4,
        0x28A58901035B2C99E36A7D29B587A215C9E59268E2F8E01A175720971CCF04EC,
        0x112F6D8D42B0A0D123A07865CA1376DF317A2A14FFC0191226F38A8ADFD6238,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x8C6EB19C016D1833174DDA182D266D5C727F97FB4D01F1DAF906B6D3C6E2308,
        0x1359D2D6C8B5A116D0B38B95F9C642DF75B1BE9A48C8698ECFEA9103F73F1879,
        0x10C5052EC67AB9B6A467C1CC1878D91AAA07AACF7725F8A5ED42B699C4AF3CA7,
        0x583C4D292D54F3CDB708803E6338FC6AFDB188D5D4E9F060193823684C96C75,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x2D94A1C55BE382151A4054C5B96322E7BCD1FE2B3E076E16EE2C18BFC06F57B4,
        0x15E3402FDDE8770FB997369579C1B1703EF77C671927EAD80DBC64DD2211C3EC,
        0x185BE98784817F22F7B21E6B867D5A71B5000BEF8BB902EB302677E20A727BE3,
        0x18DB4321C721C03666ED8927C89890AA8AAD1B00C054547B5CA14CD94DE467B6,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x2A852B6247F5D61F0C390B3F3D799188528849BCD2CD0AFF4EB2134A039B5126,
        0x2510AEED51B7F506E65FB9A18EE0124AA5276F6DE1CD771B165930204DA58F22,
        0xF2074A32EB8260FB5BD3A236F03A47B47B7FB54DCAD1D7977D6486513BAB5F2,
        0x2F4C69297866BD45A8270E19941926CEC3531C9E12C4C2C84971404BFA044090,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x154668727D2DBADF05D083A65093C0D0E92DF5FD5F3FD75E9B792C562A37473F,
        0x1E6FFC5D6A1FF5DC4FD77FC5AB5C8C4E8D3E2E375BCD1194A91E5B0F7B13CADF,
        0x2CF1A1D7C44309109D75ACBC9395CB8398C8B2D428538571FAFA389DA29990C6,
        0x140FB39A89F26F6D87CF76CD5CE8DA47AA5D8A023E24CF016ECF64CF793C9880,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x1289D13D58A17B5BF0712B201FB3CDDFCE2C16DAC159990B8298A93A8589F9E8,
        0xF45CF974D2C9EDB5781E8D3D207ADC8370CF56BC5218749610920FE98B2DB2E,
        0x11909C81A16518046B79EDFD24F5ABCC585A81D1B333568B8687A1C9ECEB44D4,
        0x2990B23C81882F7709F3B891A0E3DA4D6917672F2D5A1041FD7BBD6792330D16,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x609551B14716CA3CD5560E0821E7285E0A083EA9A16DC102ECF461E4AEF7277,
        0xC8C1ABDFAB99D03FD93DCED2467354B6175DE1755F4F93DC0880EAA08D03F77,
        0x138BD098C4923B9FBD02F33F8BEC6C730DB3FED298EC09F78A7A55D08F2E0B10,
        0x2E61E4BC021630114673F0F77161AE55DCD0B45CE07D9AE3F21BB5A3190F14C0,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x124860913E3DF8F65A9C4060CE3297C626ABD1C22401C905DDB408260D8E910,
        0x13807F89C394A133EC104804D955CBE125F24C5701D98286C6AC8B7ED052EC8,
        0x2E88D1A6938F0788132AA9EEAEC08D2F59AA444050C8F4C4E85578ABB0FC2FE5,
        0x1F3D24F17CFC6050A0CBF64E1F1787E2257BE3C3BA607C2E8FCC1F26ABF3104,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x1FE1CB0E2AE169F83B9D4F133D41FB5B3FE6C76A82A916BFD9B62F82F0F8D0BF,
        0xEF79351229409CD353329221229827E19946F3D8D1C48BF5E3377F9177071F3,
        0x18FB2E46FC1B90FE1C4893EF77A9D111507551883127860E89088608373BEDA9,
        0x77AFE2579F42EC14C32EF0761E23A3CC0AD6263A68C5CB61916BD57120D1868,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x79769092DAA5A752642C04CCF8A6EA54E2AC9836FDD65D248B186F1490B7B99,
        0x1D8BF229C19968F0254EB6E09C5C8BFD67EB9734606B676B663C76CF76BAB4A5,
        0x2A33B7D855E7FE55F93556E49E4B37737664F14236F17256428F29F6EC1BDDAD,
        0x25B0331D7E2B15AF4EC161C86E84BA6AB2056077E7AA7536340DC3187CCCA8B2,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x762098F5FE26598CCBF45E4810211B0FFCF8CCBB92C16E2F4F13F22342474E2,
        0xE234D720D70B2886D0DA4C007B1BDA42362E144185C70716DECE2B6172C2514,
        0x1D82BEDCCD2BC8A06E3742E720B7FEC2EA72182F11C0C60D135C811152AA4B60,
        0x480064D4B3EB0ADA5E9A3E7D05930B7C3397FD6B94D481314BD1C690A17C979,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x10A892763B3CCA9EF7593FBB1140EDC8C8E4580568560CF41867F7464FB0C11A,
        0xB5EC64548EA841AC921F9B2553680785978B315667AE4714DDE4CD7F4DE8B91,
        0x10554ACA4E348E5949761BD7131DFAEBD78010EDD030E1A9CE3C65C9DB931D46,
        0x15BE66F38D86B0998B93655462B1F475B9BE9DE306E150D4AC648FAB3DB0CFF6,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x176AD3600FD3491182D182957FFAD01BF6C26E9D4AB0C23CAAF308E427D3DBE8,
        0x2B6F355B3DBF65F09335001D705AC125E3BEB20F4FC11BD3CE82B5CF0AF2E6F2,
        0x1C85C06A6D5D40D81D7C89EDEFB32D1A8448C51288FA296B6DE9FF788C77451,
        0x20E1E876C4746A0CBD9A51D76B2E25F82361C389E43F7D1F51A70AAAC2460D79,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x20E46219F684186D2A024B637BC35A29EE3B08CE737701392D987DDA9217FA08,
        0x2EA7279DB9F2AA0F654E987907277C24480766367A8BD90E28BE0F2ED6091367,
        0x136BE2A7F18924C9362096D472BC75CA0969DC077C9171B1641BE95091780F74,
        0x1CA2033501BAA3F73067C4300FB0F51119ED5736FBC8F1F6C924BAF0DF5A0E9E,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0xA82F199C2505277ECAA75E495F34E3525824F7A4A9D9FA1DA810832B48A50C7,
        0xECF10485307B4BAE92FEFB0D7F7782A9F37A2722E7ED9EB7925A2DEA580B7D5,
        0x7B642138DFD6A6DD12AA22F08A8296D68615C8478F13AF16AEBBBB339A3936B,
        0x1D9DDA43A25593FFD2256D34921FB86ED70E760BA76D61E9CBC3B6DD0F1A2150,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x2F1AF228520C8B751DC91136C91C6BCCD5367EB08213D392958CE2FD3D7D2FCE,
        0x1FECFE833AD540455C6D6C1AB3DE4ABAE61ADA625A1A2B6B18551A45A6CDE123,
        0x18FC8E608C735B2B3B0D7583460227575657FF8A77ABE637BDD3AD28E4A23C88,
        0x28F740BC1182E9706EBF03CB3F53ABA8A43CE0B618783A5586388A7547FAA815,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x47998CC0AF5A26B94AD301E4B998D29E960A4851CFD13822BED35B7146966A4,
        0x1B5F1525B31DB911DDA43E415E1B9A3A9725C7B52E880EE130A14A692B777B70,
        0x275A83FA5D19B4535F65E965A90EAC9BF770AE9BD1D7B1AF945FA57ED5C8DE6E,
        0x2E8789257ED2CBCCCB430568E49BC9DC2A563359808C9897CE3E40A6F6A27AA8,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x927F46CFE80FEEFEB2721A4C09E9D17F60C34500DCD6E41E2925A39C8E2C7C1,
        0x1F868AE04832A5DBC37619BFE6AB6A97FD8FB2CFBC1ECF9E0E484BBFE7698101,
        0x9D7A11E27D2F53109B73F745B2DEFED65D94BA80F308FB19CE6D56C9B45EFF4,
        0x282D857CFE8DA3B5104E1C2823FB7C5B9A7B25924FDA5995B0C351AA2B879DFF,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x20BA8A9FCEC815B13F349FF830AE663B27576E135C0744F6987FB0F6FF49C217,
        0x11B6AFC91E32F1CA4589FBA12E657D226D57B471DDD2AB1B66A8AE4DCBFB136E,
        0x2E666402AC9CC588316E335C7D93DB344788EEC2C72DDF3F908141736CEBC3BE,
        0x17522E0E9E64F795A202A110E283FAAD7057AEC5C9ED9A1A74920F2794F18595,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x2D2ED17F7A1F3EE9E20B470CAD4CC7319E6ADB40E2FF24B7878CB9878EDBD3B9,
        0x1A81EFB19D7E1EDAA96FA276E89E85D08F75E54A8136F4D73C937DA16C7BF9F4,
        0x27FF57C1CA847E57210A7B44E52E5630F299C5F451C7A0D515A16BB3BD33E237,
        0x1C1A8E22230ABCD13C5BE96031BFA167840D117B3C6A5A0A11BE26A7F5FB1A94,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x2A1C3F15D4927C843627A9CD533E4250D81E7774D2C32B59D5836F9C19A5657,
        0x2DDBB7239EB904D81C52499B37CB4BE1AF0373A10AC112E185ACB219899357E4,
        0xDFF198393085A754E0D6FAEC54BE81D8EDF8BC25EDADAB48A86FAD6DA0AFB60,
        0x10D50C2473146BBC76275FCC589D038DEC8DB28728789F28B6D5F504BD1645CA,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x61E8328FB5593F92A53DFD40E1022E6231BA45948506282536B08B4476C1538,
        0x1B589243847198DED90B644BEE31AC58067DEBF3F07D3C51CFA5A0DD9F6D9784,
        0x4B00C0DA1F851E59863B053BD4C6087190F0BDCCED99D5CE6F67A420A3BD1F7,
        0x239941A46C2B93D9126A70163009A7AC27F8A8D42E35018B3BEC8CDCB5DDFD67,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x204F26CA7993B03AC2C35377CB0A3712BFC9BC3EC0BFECB4E87EF6814ACF2EA2,
        0x85AFF9C7FDADBA039D832D8BE165A1E5747CF7308D515E348EF117E926D721C,
        0x249042A8DC111F27C4AE9DB044C0B0B3F10E57D05E093158EFD375DF00EA2068,
        0x6E799BCDF2B4A74542854F3029803E2F84550665203327B3E0825977413E96B,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x1CB3CAED4BFFB6ACA9F4D2C002921BC3FFFED333CAE12085C612496183B87996,
        0xB47E9755FAE480128A128BFD4FAA6A3DD6EA03CAB566889DCD99E84D310D51C,
        0xC7E4CEA365C2061920A0C9FD2C360A6506293BC024FD1CA3F0BB730DA886A4F,
        0x21DA1F701BAC77BCBBAA30D964D6F6F63DBE1B20D9D6988C8DCD7BA4187215DF,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x9AE612E8BA1CA1370905FB67899D10DB86B47BD19965B6EDD1A9486E3C6CC55,
        0x262E1E0B56CAC47FC150F284491190E6AAB75445B0C99373FE1F7A0E3B95CF3D,
        0x234BF4A7DCE7587C2C87C293E3BB7C9E2A7BFA5F29FD4DDEAA5D3F67491D34BD,
        0x2F6CBAC694C886B02D0A527CAC744FB658D2690E213D7432EEE67F6CB69F70C2,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x22ACCB18B7C49B4B7BB8C9FDF78B7ADED52AA1842FFF818D9A3300876DEC3AD9,
        0x81E2F0652F898C6D659F22D2C77BE302EABD9182A0B3D3CBF623A1DF7F8F2FC,
        0x12C0A25E70D006ECCEA3ADA75D669B8C534B962890F3FFC016B3186AD675B935,
        0x10EF9C23848128CC2FD6FC869DF24D7AB56EFD349EDD56F49F8D4F2381DF3259,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x2161CD280772819DD4A81262B71DF1BCC2C1D41B9491E0620BDA347962B240F0,
        0x2CEBB0AE5108318EB406590041B5248292533364F799BC41B7F4FDD12CB8D38A,
        0x2B2092F86B5979A7FE4F7C22D9561F3BF2852283A656880FB759E08709A0A62F,
        0x1566B3402D774B8C08146188425A442450CFC900CF643E7382B2D8507A065FED,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x11A316AA31607F268FB4C56D6C57BA01627C3635FCCF8D3D1A163E601D1A0173,
        0xDE7EE069C934256B782648B560E595408A5E8434644609152E353D9C2874E44,
        0x2D36F4029245704CC84DF0297708C5E5845C36AE706C72E67128B8949EAB1AF,
        0x1B8CC326B5EE160F53198C217FB34E899BDE46CD82DABDC284D7951D546F858,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x27625DA0F73EA07110689FB2187B71694CBF9203FD4DDF8A96ECE85407550EBB,
        0x1CD8338A3E5B1AD7CDC0DA581A6950F6DEA349C3EDDA06CB99BA025B94E4790D,
        0x5EA02D65B209F6DA763856C94B6438C78A8AED8D3E67E877A10A84072741A56,
        0x9F7CB68D4E388F85366CFCF284A895D8B6250CED627E810817743CE03330A55,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x18C6230DDC0F896827B043F5E58DBD1AEC13995A202E4EBCDFEB969E9D5C1212,
        0x73A6114B997285E1A91C0A0FDCCDAA8452E4F07BFD2E1A10578232096DB6DCD,
        0x2E78746340B2A6D222C6A1FC0838ADF5FE013F39B1660CE7A3E7742B2F37BE7F,
        0x7AA27E7150BADDD06303AD8E5E4BF4249B7EA846553DEF28E675259D3E5C851,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0xB66FDEC210EA4EABF623D2712CF4D9FA90273CCB4643F680CBC98345715EAD8,
        0x2FB6A29D9F394A589B633B8A4D6BE51C9C0601CE0B140BE641ACEA41C49AA5E3,
        0x29025CC66FD041C4FC845E9C1C2CD1288569FB243D049BD675A69DC889B2CE2A,
        0x150963F0ACA9BCBE4126214AB9C627A6F7ED731CFA695168B85D534B17BE3F48,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0xED59780302257663F72C1BFC6656EB7B5BCA2E47BEC0D5798A08A32A61A8A65,
        0x7E19CB8A893369B3D30AE188C767F391C11888A3000DEBFC8D30C06143CC084,
        0x600C7D2B6946345E5F1EEEAFB5EB8EC2B6ECFE528D2C052CD860AFB4A3AA272,
        0x596083B6C972BC13022A1F33D6523B4773F2CD0A480E19EA0125119F0385705,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0x210B5C36F27A07D97F98B9D8663D85DB2E64513099A8E1EF6DB21043631E24C4,
        0x13BB2764BF1475CFC7BB9F3D563C5CC201C2489874E9159326A8F4930B7883F9,
        0x202CF557D625C26080EB082862A76757287872B181E89997219E4B7576E24D30,
        0xE561C3F8BD4F76E76D49E97142D220601FBC5A03D905A4728EA1F95FD8824B2,
        0x109B7F411BA0E4C9B2B70CAF5C36A7B194BE7C11AD24378BFEDB68592BA8118B,
        0xDE20097480E7555471785DE07BD9809D57DD859BBE827307C33AE9ED7890597,
        0x72F2A6287FB984BB810DF8C5788EEBCFD2825613CB72BB80CDE8EDD76D2E97D,
        0x2969F27EED31A480B9C36C764379DBCA2CC8FDD1415C3DDED62940BCDE0BD771,
        0x143021EC686A3F330D5F9E654638065CE6CD79E28C5B3753326244EE65A1B1A7,
    ]

    POSEIDON_C = [circuit.set_or_get_constant(x) for x in POSEIDON_C]
    POSEIDON_M = [[circuit.set_or_get_constant(y) for y in x] for x in POSEIDON_M]
    POSEIDON_P = [[circuit.set_or_get_constant(y) for y in x] for x in POSEIDON_P]
    POSEIDON_S = [circuit.set_or_get_constant(x) for x in POSEIDON_S]

    # Initial Ark
    state = ark(t, POSEIDON_C, 0, state)

    # # First half of full rounds
    for r in range(n_rounds_f // 2 - 1):
        state = [sigma(val) for val in state]
        state = ark(t, POSEIDON_C, (r + 1) * t, state)
        state = mix(t, POSEIDON_M, state)

    # # Middle round
    state = [sigma(val) for val in state]
    state = ark(t, POSEIDON_C, (n_rounds_f // 2) * t, state)
    state = mix(t, POSEIDON_P, state)

    # # Partial rounds
    for r in range(n_rounds_p):
        state[0] = sigma(state[0])
        state = mix_s(
            t,
            POSEIDON_S,
            r,
            [circuit.add(state[0], POSEIDON_C[(n_rounds_f // 2 + 1) * t + r])]
            + state[1:],
        )

    # # Second half of full rounds
    for r in range(n_rounds_f // 2 - 1):
        state = [sigma(val) for val in state]
        state = ark(
            t, POSEIDON_C, (n_rounds_f // 2 + 1) * t + n_rounds_p + r * t, state
        )
        state = mix(t, POSEIDON_M, state)

    # # Final round
    state = [sigma(val) for val in state]

    # Final MixLast
    return mix_last(t, POSEIDON_M, 0, state)


if __name__ == "__main__":
    # Compute the Poseidon hash
    z = poseidon_hash(x, y)

    # Define the output of the circuit
    circuit.extend_struct_output(u384("z", [z]))

    # Compile and print the compiled circuit
    compiled_code, function_name = circuit.compile_circuit()
    print(compiled_code)
